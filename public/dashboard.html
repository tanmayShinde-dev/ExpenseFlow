<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#64ffda">
    <meta name="description" content="ExpenseFlow Dashboard - Smart Money Management">
    <title>Dashboard - ExpenseFlow</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iOCIgZmlsbD0iIzY0ZmZkYSIvPgo8cGF0aCBkPSJNOCAxMkg4LjAyNEgyNFYyMEgxNlYyNEgyNEMyNC44IDI0IDI1LjYgMjMuMiAyNS42IDIwVjEyQzI1LjYgMTAuOCAyMy4yIDggMjQgOEgyNEM4IDggOCAxMC44IDggMTJWMjBDOCAxOS4yIDEwLjggMjQgOCAyNEgxMlYyMEg4VjEyWiIgZmlsbD0iIzBmMGYyMyIvPgo8L3N2Zz4K">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="dashboard.css">
    <link rel="stylesheet" href="expensetracker.css">
    
    <!-- Clerk Authentication SDK -->
     <script
    async
    crossorigin="anonymous"
    data-clerk-publishable-key="your publishable key here"
     src="https://your-app-slug.clerk.accounts.dev/npm/@clerk/clerk-js@5/dist/clerk.browser.js"
    type="text/javascript"
  ></script>
    
    <style>
      /* Cursor Trail Styles */
      .cursor-trail-container {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 999999;
      }

      .trail-dot {
        position: absolute;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: linear-gradient(135deg, #64ffda 0%, #00b4d8 100%);
        box-shadow: 
          0 0 15px rgba(100, 255, 218, 0.8),
          0 0 30px rgba(100, 255, 218, 0.4);
        transform: translate(-50%, -50%);
        will-change: transform, opacity;
        mix-blend-mode: screen;
        transition: opacity 0.3s ease, transform 0.3s ease;
      }

      .trail-dot:first-child {
        width: 12px;
        height: 12px;
        z-index: 2;
      }

      .cursor-clicking {
        transform: translate(-50%, -50%) scale(1.5);
        background: linear-gradient(135deg, #ff6b9d 0%, #ffcc00 100%) !important;
      }

      .cursor-hovering {
        transform: translate(-50%, -50%) scale(1.3);
      }
    </style>
</head>

<body>
  <div class="cursor-trail-container" id="cursor-trail"></div>

  <div class="dashboard-container">
    <header class="dashboard-header">
      <h1>ExpenseFlow Dashboard</h1>
      <div class="user-info">
        <span id="user-name">Loading...</span>
        <button onclick="handleLogout()" class="btn-secondary">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </header>

    <main class="dashboard-main">
      <div class="stats-grid">
        <div class="stat-card">
          <h3>Total Balance</h3>
          <p class="stat-value" id="total-balance">$0.00</p>
          <span class="stat-change positive">+0%</span>
        </div>
        <div class="stat-card">
          <h3>Monthly Income</h3>
          <p class="stat-value" id="monthly-income">$0.00</p>
          <span class="stat-change positive">+0%</span>
        </div>
        <div class="stat-card">
          <h3>Monthly Expenses</h3>
          <p class="stat-value" id="monthly-expenses">$0.00</p>
          <span class="stat-change negative">+0%</span>
        </div>
        <div class="stat-card">
          <h3>Savings</h3>
          <p class="stat-value" id="savings">$0.00</p>
          <span class="stat-change positive">+0%</span>
        </div>
      </div>

      <div class="dashboard-content">
        <div class="recent-transactions">
          <h2>Recent Transactions</h2>
          <ul id="transaction-list" class="transaction-list">
            <li class="loading">Loading transactions...</li>
          </ul>
        </div>

        <div class="quick-actions">
          <h2>Quick Actions</h2>
          <button class="action-btn" onclick="window.location.href='index.html'">
            <i class="fas fa-plus"></i> Add Expense
          </button>
          <button class="action-btn" onclick="window.location.href='analytics.html'">
            <i class="fas fa-chart-line"></i> View Analytics
          </button>
          <button class="action-btn" onclick="window.location.href='goals.html'">
            <i class="fas fa-bullseye"></i> Manage Goals
          </button>
        </div>
      </div>
    </main>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Cursor Trail Script -->
  <script>
    (function() {
      document.body.style.cursor = 'none';
      const container = document.getElementById('cursor-trail');
      const coords = { x: window.innerWidth / 2, y: window.innerHeight / 2 };
      const trailCircles = [];
      const COUNT = 12;

      for (let i = 0; i < COUNT; i++) {
        const circle = document.createElement('div');
        circle.className = 'trail-dot';
        const opacity = 0.9 - (i / COUNT) * 0.8;
        circle.style.opacity = opacity.toString();
        const scale = 1 - (i / COUNT) * 0.5;
        circle.style.transform = `translate(-50%, -50%) scale(${scale})`;
        container.appendChild(circle);
        trailCircles.push({ 
          element: circle, 
          x: coords.x, 
          y: coords.y,
          targetX: coords.x,
          targetY: coords.y
        });
      }

      let velocity = { x: 0, y: 0 };
      let lastMouseX = coords.x;
      let lastMouseY = coords.y;

      window.addEventListener('mousemove', e => {
        coords.x = e.clientX;
        coords.y = e.clientY;
        velocity.x = e.clientX - lastMouseX;
        velocity.y = e.clientY - lastMouseY;
        lastMouseX = e.clientX;
        lastMouseY = e.clientY;
      });

      window.addEventListener('mousedown', () => {
        trailCircles.forEach(circle => circle.element.classList.add('cursor-clicking'));
      });

      window.addEventListener('mouseup', () => {
        trailCircles.forEach(circle => circle.element.classList.remove('cursor-clicking'));
      });

      window.addEventListener('mouseover', e => {
        const interactive = e.target.closest('a, button, input, select, textarea, [role="button"]');
        trailCircles.forEach(circle => {
          circle.element.classList.toggle('cursor-hovering', !!interactive);
        });
      });

      function animateTrail() {
        let targetX = coords.x;
        let targetY = coords.y;

        trailCircles.forEach((circle, index) => {
          if (index === 0) {
            circle.targetX = targetX;
            circle.targetY = targetY;
          } else {
            circle.targetX = targetX;
            circle.targetY = targetY;
          }

          const easing = index === 0 ? 0.3 : 0.15;
          circle.x += (circle.targetX - circle.x) * easing;
          circle.y += (circle.targetY - circle.y) * easing;

          circle.element.style.left = circle.x + 'px';
          circle.element.style.top = circle.y + 'px';

          targetX = circle.x;
          targetY = circle.y;
        });

        requestAnimationFrame(animateTrail);
      }

      window.addEventListener('mouseleave', () => {
        trailCircles.forEach(circle => circle.element.style.opacity = '0');
      });

      window.addEventListener('mouseenter', () => {
        trailCircles.forEach((circle, index) => {
          const opacity = 0.9 - (index / COUNT) * 0.8;
          circle.element.style.opacity = opacity.toString();
        });
      });

      animateTrail();
    })();
  </script>

  <!-- Dashboard functionality -->
  <script>
    // Logout handler
    async function handleLogout() {
      try {
        if (window.Clerk) {
          await window.Clerk.signOut();
        }
        window.location.href = '/login.html';
      } catch (error) {
        console.error('Logout error:', error);
        window.location.href = '/login.html';
      }
    }

    // Authentication check and user info
    window.addEventListener('load', async function() {
      try {
        await window.Clerk.load();
        
        if (!window.Clerk.user) {
          sessionStorage.setItem('redirectAfterLogin', window.location.href);
          window.location.href = '/login.html';
          return;
        }

        // Display user name
        const userName = window.Clerk.user.fullName || 
                        window.Clerk.user.primaryEmailAddress?.emailAddress || 
                        'User';
        document.getElementById('user-name').textContent = userName;

        // Load dashboard data
        loadDashboardData();
      } catch (error) {
        console.error('Auth check error:', error);
        window.location.href = '/login.html';
      }
    });

    // Load dashboard data
    async function loadDashboardData() {
      try {
        const token = await window.Clerk.session.getToken();
        
        // Fetch dashboard stats
        const response = await fetch('/api/expenses/summary', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const data = await response.json();
          updateDashboardUI(data);
        }
      } catch (error) {
        console.error('Error loading dashboard data:', error);
      }
    }

    // Update UI with data
    function updateDashboardUI(data) {
      if (data.balance !== undefined) {
        document.getElementById('total-balance').textContent = `$${data.balance.toFixed(2)}`;
      }
      if (data.income !== undefined) {
        document.getElementById('monthly-income').textContent = `$${data.income.toFixed(2)}`;
      }
      if (data.expenses !== undefined) {
        document.getElementById('monthly-expenses').textContent = `$${data.expenses.toFixed(2)}`;
      }
      if (data.savings !== undefined) {
        document.getElementById('savings').textContent = `$${data.savings.toFixed(2)}`;
      }

      // Update transactions list if available
      if (data.transactions && data.transactions.length > 0) {
        const listEl = document.getElementById('transaction-list');
        listEl.innerHTML = data.transactions.map(tx => `
          <li class="transaction-item ${tx.type}">
            <div class="transaction-info">
              <strong>${tx.description}</strong>
              <span class="transaction-date">${new Date(tx.date).toLocaleDateString()}</span>
            </div>
            <span class="transaction-amount ${tx.type}">
              ${tx.type === 'income' ? '+' : '-'}$${Math.abs(tx.amount).toFixed(2)}
            </span>
          </li>
        `).join('');
      }
    }
  </script>

  <script src="dashboard.js"></script>
</body>
</html>
